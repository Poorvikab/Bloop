# Prometheus Alert Rules for Bloop Platform
groups:
  - name: bloop_platform_alerts
    interval: 30s
    rules:
      # High Error Rate
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
            /
            sum(rate(http_requests_total[5m])) by (service)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High error rate detected in {{ $labels.service }}"
          description: "Error rate is {{ $value | humanizePercentage }} for service {{ $labels.service }}"

      # High Latency
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 2
        for: 10m
        labels:
          severity: high
          component: api
        annotations:
          summary: "High latency detected in {{ $labels.service }}"
          description: "P95 latency is {{ $value }}s for service {{ $labels.service }}"

      # Service Down
      - alert: ServiceDown
        expr: up{job=~"api-gateway|video-service|avatar-service"} == 0
        for: 2m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} has been down for more than 2 minutes"

      # High CPU Usage
      - alert: HighCPUUsage
        expr: |
          (
            sum(rate(container_cpu_usage_seconds_total{namespace="bloop-prod"}[5m])) by (pod)
            /
            sum(container_spec_cpu_quota{namespace="bloop-prod"} / container_spec_cpu_period{namespace="bloop-prod"}) by (pod)
          ) > 0.9
        for: 10m
        labels:
          severity: high
          component: infrastructure
        annotations:
          summary: "High CPU usage in pod {{ $labels.pod }}"
          description: "CPU usage is {{ $value | humanizePercentage }} for pod {{ $labels.pod }}"

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: |
          (
            sum(container_memory_working_set_bytes{namespace="bloop-prod"}) by (pod)
            /
            sum(container_spec_memory_limit_bytes{namespace="bloop-prod"}) by (pod)
          ) > 0.9
        for: 10m
        labels:
          severity: high
          component: infrastructure
        annotations:
          summary: "High memory usage in pod {{ $labels.pod }}"
          description: "Memory usage is {{ $value | humanizePercentage }} for pod {{ $labels.pod }}"

      # Pod Restart Loop
      - alert: PodRestartLoop
        expr: |
          rate(kube_pod_container_status_restarts_total{namespace="bloop-prod"}[15m]) > 0
        for: 5m
        labels:
          severity: high
          component: infrastructure
        annotations:
          summary: "Pod {{ $labels.pod }} is in restart loop"
          description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last 15 minutes"

      # Database Connection Pool Exhaustion
      - alert: DatabaseConnectionPoolExhaustion
        expr: |
          (
            sum(db_connections_active) by (instance)
            /
            sum(db_connections_max) by (instance)
          ) > 0.9
        for: 5m
        labels:
          severity: high
          component: database
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "Connection pool usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # Redis Memory Usage
      - alert: RedisHighMemoryUsage
        expr: |
          (
            redis_memory_used_bytes
            /
            redis_memory_max_bytes
          ) > 0.9
        for: 5m
        labels:
          severity: high
          component: cache
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis memory usage is {{ $value | humanizePercentage }}"

      # RabbitMQ Queue Buildup
      - alert: RabbitMQQueueBuildup
        expr: rabbitmq_queue_messages > 1000
        for: 10m
        labels:
          severity: high
          component: queue
        annotations:
          summary: "RabbitMQ queue {{ $labels.queue }} has message buildup"
          description: "Queue {{ $labels.queue }} has {{ $value }} messages"

      # Video Generation Failure Rate
      - alert: HighVideoGenerationFailureRate
        expr: |
          (
            sum(rate(video_generation_failed_total[10m]))
            /
            sum(rate(video_generation_total[10m]))
          ) > 0.1
        for: 10m
        labels:
          severity: high
          component: video-service
        annotations:
          summary: "High video generation failure rate"
          description: "Video generation failure rate is {{ $value | humanizePercentage }}"

      # Avatar Generation Slow
      - alert: AvatarGenerationSlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(avatar_generation_duration_seconds_bucket[10m])) by (le)
          ) > 120
        for: 15m
        labels:
          severity: medium
          component: avatar-service
        annotations:
          summary: "Avatar generation is slow"
          description: "P95 avatar generation time is {{ $value }}s"

      # Disk Space Low
      - alert: DiskSpaceLow
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/"}
            /
            node_filesystem_size_bytes{mountpoint="/"}
          ) < 0.1
        for: 5m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Disk space is low on {{ $labels.instance }}"
          description: "Only {{ $value | humanizePercentage }} disk space remaining"

      # Certificate Expiring Soon
      - alert: CertificateExpiringSoon
        expr: |
          (
            certmanager_certificate_expiration_timestamp_seconds
            -
            time()
          ) < 604800
        labels:
          severity: high
          component: security
        annotations:
          summary: "Certificate {{ $labels.name }} expiring soon"
          description: "Certificate expires in {{ $value | humanizeDuration }}"

      # Backup Failed
      - alert: BackupFailed
        expr: time() - backup_last_success_timestamp_seconds > 86400
        labels:
          severity: critical
          component: backup
        annotations:
          summary: "Backup has not succeeded in 24 hours"
          description: "Last successful backup was {{ $value | humanizeDuration }} ago"

      # API Rate Limit Hit
      - alert: APIRateLimitHit
        expr: rate(http_requests_total{status="429"}[5m]) > 10
        for: 5m
        labels:
          severity: medium
          component: api
        annotations:
          summary: "API rate limit being hit frequently"
          description: "Rate limit hit {{ $value }} times per second"

      # GPU Utilization Low
      - alert: GPUUtilizationLow
        expr: |
          avg(DCGM_FI_DEV_GPU_UTIL) by (gpu, pod) < 20
        for: 30m
        labels:
          severity: low
          component: gpu
        annotations:
          summary: "GPU utilization is low in {{ $labels.pod }}"
          description: "GPU {{ $labels.gpu }} utilization is {{ $value }}%"

      # Deployment Rollout Stuck
      - alert: DeploymentRolloutStuck
        expr: |
          kube_deployment_status_condition{condition="Progressing",status="false"}
          *
          on(deployment) group_left()
          kube_deployment_spec_replicas != kube_deployment_status_replicas_available
        for: 15m
        labels:
          severity: critical
          component: deployment
        annotations:
          summary: "Deployment {{ $labels.deployment }} rollout is stuck"
          description: "Deployment has been stuck for more than 15 minutes"
